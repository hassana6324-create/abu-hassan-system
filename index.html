<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e272e">
    <meta name="application-name" content="Ø£Ø¨Ùˆ Ø­Ø³Ù†">
    <link rel="manifest" id="my-manifest-placeholder">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2554/2554039.png"> 
    
    <title>Ù†Ø¸Ø§Ù… Ø£Ø¨Ùˆ Ø­Ø³Ù† Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† --- */
        :root {
            --bg-dark: #1e272e;
            --bg-light: #f5f5f5;
            --card-bg-dark: #2d3436;
            --card-bg-light: #ffffff;
            --text-main-dark: #dfe6e9;
            --text-main-light: #333333;
            --accent: #e17055;
            --green: #00b894;
            --red: #d63031;
            --blue: #0984e3;
            --whatsapp: #25D366;
            --yellow: #f1c40f;
            --purple: #6c5ce7;
            --modal-bg-dark: #353b48;
            --modal-bg-light: #f9f9f9;
            --border-dark: #4d5861;
            --border-light: #ddd;
            --input-bg-dark: #222;
            --input-bg-light: white;
            --input-border-dark: #555;
            --input-border-light: #ccc;
            --input-text-dark: white;
            --input-text-light: #333;
            --detail-bg-dark: #222;
            --detail-bg-light: #f9f9f9;
        }

        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-main-dark);
        }
        body.dark-mode .content-area {
            background-color: var(--bg-dark);
        }
        body.dark-mode .product-card {
            background: var(--card-bg-dark);
            border-color: var(--border-dark);
            color: var(--text-main-dark);
        }
        body.dark-mode .modal-content {
            background: var(--modal-bg-dark);
            color: var(--text-main-dark);
            border-color: var(--border-dark);
        }
        body.dark-mode .modal-content h3 {
            color: var(--text-main-dark);
        }
        body.dark-mode .search-input {
            background: var(--input-bg-dark);
            border-color: var(--input-border-dark);
            color: var(--input-text-dark);
        }
        body.dark-mode .stat-box {
            background: var(--card-bg-dark);
            border-color: var(--border-dark);
        }
        body.dark-mode .cat-tab {
            background: #4d5861;
            color: #b2bec3;
        }
        body.dark-mode .cat-tab.active {
            background: var(--accent);
            color: white;
        }
        body.dark-mode .modal-input {
            background: var(--input-bg-dark);
            border-color: var(--input-border-dark);
            color: var(--input-text-dark);
        }
        body.dark-mode .modal-input::placeholder {
            color: #aaa;
        }
        body.dark-mode .detail-row {
            border-bottom-color: #444;
            color: var(--text-main-dark);
        }
        body.dark-mode .history-item {
            border-bottom-color: #555;
        }
        body.dark-mode .chart-container {
            background: var(--card-bg-dark);
            color: var(--text-main-dark);
        }
        body.dark-mode .detail-container {
            background: var(--detail-bg-dark);
            color: var(--text-main-dark);
        }
        body.dark-mode .detail-container .detail-row {
            border-bottom-color: #444;
            color: var(--text-main-dark);
        }
        body.dark-mode .detail-container .detail-row span {
            color: var(--text-main-dark);
        }
        body.dark-mode .detail-container .detail-total {
            color: var(--accent);
        }

        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ */
        body.light-mode {
            background-color: var(--bg-light);
            color: var(--text-main-light);
        }
        body.light-mode .content-area {
            background-color: var(--bg-light);
        }
        body.light-mode .product-card {
            background: var(--card-bg-light);
            border-color: var(--border-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: var(--text-main-light);
        }
        body.light-mode .modal-content {
            background: var(--modal-bg-light);
            color: var(--text-main-light);
            border-color: var(--border-light);
        }
        body.light-mode .modal-content h3 {
            color: var(--text-main-light);
        }
        body.light-mode .search-input {
            background: var(--input-bg-light);
            border-color: var(--input-border-light);
            color: var(--input-text-light);
        }
        body.light-mode .stat-box {
            background: var(--card-bg-light);
            border-color: var(--border-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        body.light-mode .cat-tab {
            background: #e0e0e0;
            color: #666;
        }
        body.light-mode .cat-tab.active {
            background: var(--accent);
            color: white;
        }
        body.light-mode .modal-input {
            background: var(--input-bg-light);
            border-color: var(--input-border-light);
            color: var(--input-text-light);
        }
        body.light-mode .modal-input::placeholder {
            color: #666;
        }
        body.light-mode .detail-row {
            border-bottom-color: #eee;
            color: var(--text-main-light);
        }
        body.light-mode .history-item {
            border-bottom-color: #eee;
        }
        body.light-mode .chart-container {
            background: var(--card-bg-light);
            color: var(--text-main-light);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        body.light-mode .detail-container {
            background: var(--detail-bg-light);
            color: var(--text-main-light);
            border: 1px solid var(--border-light);
        }
        body.light-mode .detail-container .detail-row {
            border-bottom-color: #eee;
            color: var(--text-main-light);
        }
        body.light-mode .detail-container .detail-row span {
            color: var(--text-main-light);
        }
        body.light-mode .detail-container .detail-total {
            color: var(--accent);
            font-weight: bold;
        }
        body.light-mode .detail-container .customer-info {
            color: #666;
        }
        body.light-mode .detail-container .date-info {
            color: #888;
        }
        body.light-mode .bottom-nav {
            background: white;
            border-top: 1px solid #ddd;
        }
        body.light-mode .nav-item {
            color: #666;
        }
        body.light-mode .nav-item.active {
            background: var(--accent);
            color: white;
        }
        body.light-mode header {
            background: linear-gradient(180deg, white 0%, #f5f5f5 100%);
            border-bottom: 2px solid var(--accent);
        }
        body.light-mode header h1 {
            color: var(--accent);
        }
        body.light-mode .header-btn {
            color: #555;
        }
        body.light-mode .invoice-box.style-formal {
            background: white;
            color: #333;
        }
        body.light-mode .debt-card {
            background: white;
            border: 1px solid #ddd;
            color: #333;
        }
        body.light-mode .debt-info h4 {
            color: #333;
        }
        body.light-mode .stock-tag {
            color: #666;
        }
        body.light-mode .stock-low {
            color: var(--yellow);
        }
        body.light-mode .stock-out {
            color: var(--red);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ù‚Ø± --- */
        .btn:active, .header-btn:active, .cat-tab:active, .nav-item:active, .modal-close-btn:active, .style-btn:active {
            transform: scale(0.92) !important; transition: transform 0.1s ease;
        }
        .product-card:active {
            transform: scale(0.95) !important;
            border-color: var(--accent) !important;
            box-shadow: 0 0 10px rgba(225, 112, 85, 0.4) !important;
            transition: all 0.1s ease;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header {
            background: linear-gradient(180deg, #2d3436 0%, #1e272e 100%);
            display: flex; flex-direction: column; gap: 0; padding: 15px; 
            border-bottom: 2px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            z-index: 100; padding-top: calc(15px + env(safe-area-inset-top)); position: relative;
            transition: background 0.3s;
        }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; position: relative; height: 40px; }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--accent); position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
        .header-icons { display: flex; gap: 15px; z-index: 2; }
        .header-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 0; min-width: 30px; display: flex; align-items: center; justify-content: center; transition: color 0.3s; }
        .lock-status-open { color: var(--green); text-shadow: 0 0 8px rgba(0, 184, 148, 0.6); }
        .lock-status-closed { color: #b2bec3; }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¬Ø±Ø³ Ù…Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        .bell-alert {
            position: relative;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .bell-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--red);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* --- Ø§Ù„ÙÙ„Ø§ØªØ± --- */
        #storeFilters { display: none; opacity: 0; transition: opacity 0.3s ease, max-height 0.3s ease; max-height: 0; overflow: hidden; margin-top: 10px; border-top: 1px solid #444; padding-top: 10px; }
        #storeFilters.show { display: block; opacity: 1; max-height: 150px; }
        .category-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 5px 15px 20px 15px; margin: 0 -15px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-tab { background: #4d5861; color: #b2bec3; padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; white-space: nowrap; cursor: pointer; transition: 0.3s; border: 1px solid transparent; }
        .cat-tab.active { background: var(--accent); color: white; border-color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(225, 112, 85, 0.6); }
        .search-wrapper { width: 100%; margin-top: 5px; }
        .search-input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 25px; border: 2px solid #4d5861; background: #353b48; color: white; font-size: 1rem; text-align: right; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s; }
        .search-input:focus { border-color: var(--accent); background: #2d3436; }

        /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ --- */
        .content-area { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; scroll-behavior: smooth; transition: background-color 0.3s; }
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding-top: 10px; }
        .product-card { 
            background: var(--card-bg-dark); 
            border: 1px solid #4d5861; 
            border-radius: 12px; 
            padding: 10px; 
            text-align: center; 
            position: relative; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
            overflow: visible; 
            user-select: none; 
            -webkit-user-select: none; 
            transition: all 0.2s ease;
            /* Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† */
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease, transform 0.3s ease, all 0.2s ease;
        }
        /* ÙƒÙ„Ø§Ø³ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« */
        .product-card.hidden {
            opacity: 0;
            transform: scale(0.8);
            height: 0;
            padding: 0;
            margin: 0;
            border: none;
            pointer-events: none;
            overflow: hidden;
        }
        .stock-tag { font-size: 0.7rem; color: #b2bec3; margin-top: 5px; display: block; }
        .stock-low { color: var(--yellow); font-weight: bold; }
        .stock-out { color: var(--red); font-weight: bold; text-decoration: line-through; }
        .short-code { position: absolute; top: 5px; right: 5px; background: var(--yellow); color: #2d3436; font-size: 0.7rem; font-weight: bold; padding: 2px 5px; border-radius: 4px; transition: right 0.3s ease; box-shadow: 0 2px 5px rgba(241, 196, 15, 0.4); }
        .short-code.shifted { right: 35px; }
        .qty-badge { position: absolute; top: -10px; right: -10px; background: var(--accent); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-size: 0.85rem; font-weight: bold; z-index: 10; border: 2px solid var(--bg-dark); box-shadow: 0 3px 8px rgba(225, 112, 85, 0.5); }

        /* --- Ø§Ù„ÙØ§ØªÙˆØ±Ø© --- */
        .invoice-box { background: white; color: black; padding: 15px; border-radius: 12px; min-height: 300px; position: relative; transition: all 0.3s ease; }
        .shop-header { text-align: center; border-bottom: 2px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .shop-header p { margin: 5px; font-size: 0.9rem; color: #333; }
        
        .invoice-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; }
        .invoice-table th { background: #636e72; color: white; padding: 8px 5px; font-weight: normal; }
        .invoice-table td { border-bottom: 1px solid #eee; padding: 8px 5px; text-align: center; vertical-align: middle;}
        .invoice-footer-note { text-align: center; margin-top: 20px; font-size: 0.75rem; color: #555; border-top: 1px solid #eee; padding-top: 5px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø± */
        .customer-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px 0;
            border-top: 1px dashed #ddd;
            border-bottom: 1px dashed #ddd;
            flex-wrap: nowrap;
        }
        .customer-info-item {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px 5px;
            border-radius: 5px;
        }
        .customer-info-item:hover {
            background-color: #f5f5f5;
        }
        .customer-info-label {
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
            white-space: nowrap;
            margin-left: 8px;
        }
        .customer-info-value {
            color: var(--blue);
            font-weight: bold;
            font-size: 0.9rem;
            text-decoration: underline;
            text-decoration-style: dashed;
            min-width: 0;
            text-align: left;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .customer-info-value.empty {
            color: #999;
            font-style: italic;
            font-weight: normal;
        }
        
        /* Ø®Ø· ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†ØµØ±ÙŠÙ† */
        .customer-info-separator {
            width: 1px;
            height: 30px;
            background-color: #ddd;
            margin: 0 10px;
        }

        /* --- Ø«ÙŠÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© --- */
        .invoice-box.style-formal { border: 2px solid #2d3436; border-radius: 0; }
        .style-formal .shop-header { border-bottom: 4px solid var(--accent); background: #f1f2f6; margin: -15px -15px 15px -15px; padding: 15px; }
        .style-formal .invoice-table th { background: var(--accent); color: white; text-transform: uppercase; border: none; }
        .style-formal .invoice-table tr:nth-child(even) { background-color: #f9f9f9; }
        .style-formal #grandTotalBox { background: #e1e1e1; color: black; border: 2px solid var(--accent); }

        .invoice-box.style-thermal { width: 100%; font-family: 'Courier New', Courier, monospace; padding: 5px; border-radius: 0; border: 1px solid #ddd; }
        .style-thermal .shop-header { border-bottom: 2px dashed black; padding-bottom: 5px; }
        .style-thermal .shop-header p, .style-thermal .shop-header h2 { color: black !important; font-weight: 900; }
        .style-thermal .invoice-table th { background: none; color: black; border-bottom: 2px dashed black; font-weight: bold; }
        .style-thermal .invoice-table td { border-bottom: none; color: black; font-weight: bold; }
        .style-thermal .invoice-footer-note { border-top: 2px dashed black; color: black; }
        
        .invoice-box.style-simple { border: 1px solid #eee; border-radius: 15px; box-shadow: none; }
        .style-simple .shop-header { border-bottom: 1px solid #eee; }
        .style-simple .invoice-table th { background: white; color: #333; border-bottom: 1px solid #333; font-weight: bold; }
        .style-simple #grandTotalBox { border: 2px solid #333; color: #333; padding: 10px; border-radius: 50px; }

        .style-switcher { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; }
        .style-btn { background: #444; border: 1px solid #666; color: #ccc; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; }
        .style-btn.active { background: var(--accent); color: white; border-color: white; font-weight: bold; }

        /* --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± --- */
        .btn { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .btn-print { background: var(--green); box-shadow: 0 4px 10px rgba(0, 184, 148, 0.4); }
        .btn-image { background: var(--blue); box-shadow: 0 4px 10px rgba(9, 132, 227, 0.4); }
        .btn-wa { background: var(--whatsapp); box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4); }
        .btn-clear, .btn-delete { background: var(--red); box-shadow: 0 4px 10px rgba(214, 48, 49, 0.4); }
        .btn-add { background: var(--accent); box-shadow: 0 4px 10px rgba(225, 112, 85, 0.4); }
        .btn-edit { background: var(--purple); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.4); } 
        .btn-partial { background: var(--yellow); color: #2d3436; box-shadow: 0 4px 10px rgba(241, 196, 15, 0.4); }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-full { width: 100%; margin-top: 10px; padding: 15px; border-radius: 12px; font-size: 1rem; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }

        .debt-card { background: var(--card-bg-dark); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 4px solid var(--red); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .debt-info h4 { margin: 0 0 5px 0; color: white; }
        .debt-amount { color: var(--red); font-weight: bold; font-size: 1.1rem; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg-dark); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #444; transition: all 0.3s; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--accent); margin: 5px 0; }
        .stat-label { font-size: 0.8rem; color: #aaa; }

        /* Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ */
        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            height: 250px;
        }
        .chart-container canvas {
            max-width: 100%;
            max-height: 200px;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© */
        .detail-container {
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            transition: all 0.3s;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid;
            text-align: right;
            transition: all 0.3s;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-total {
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid;
            transition: all 0.3s;
        }
        .customer-info {
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .date-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 200; 
            backdrop-filter: blur(3px); 
            cursor: pointer;
        }
        .modal-content { 
            background: var(--modal-bg-dark); 
            padding: 25px; 
            border-radius: 20px; 
            width: 90%; 
            max-width: 350px; 
            text-align: center; 
            border: 1px solid #555; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            max-height: 80vh; 
            overflow-y: auto; 
            transition: all 0.3s; 
            cursor: default;
        }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #555; color: white; text-align: center; border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
        .modal-close-btn { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: var(--red); color: white; border: none; border-radius: 50%; font-weight: bold; font-size: 1.2rem; line-height: 30px; cursor: pointer; box-shadow: 0 3px 8px rgba(214, 48, 49, 0.5); z-index: 10;}
        .modal-total { color: var(--accent); border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 15px; }

        .confirm-actions { display: flex; gap: 10px; margin-top: 20px; }
        .confirm-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .confirm-yes { background: var(--red); }
        .confirm-no { background: #636e72; }

        .history-item { text-align: right; padding: 10px; border-bottom: 1px solid #555; margin-bottom: 5px; }
        .hist-date { color: #aaa; font-size: 0.8rem; }
        .hist-val { font-weight: bold; }
        .hist-type-new { color: var(--red); }
        .hist-type-pay { color: var(--green); }

        #toastBox { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 300; pointer-events: none; width: 90%; max-width: 300px; }
        .toast { background: rgba(45, 52, 54, 0.95); color: white; padding: 12px; border-radius: 25px; margin-bottom: 10px; border: 1px solid var(--accent); text-align: center; backdrop-filter: blur(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #2d3436; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #444; z-index: 100; padding-bottom: calc(10px + env(safe-area-inset-bottom)); transition: background 0.3s; }
        .nav-item { color: #b2bec3; text-align: center; font-size: 0.75rem; padding: 5px 10px; border-radius: 15px; flex: 1; transition: 0.2s; }
        .nav-item.active { background: var(--accent); color: white; font-weight: bold; transform: translateY(-5px); }
        .nav-icon { display: block; font-size: 1.2rem; margin-bottom: 2px; }

        .editable-price { text-decoration: underline; text-decoration-style: dashed; cursor: pointer; color: var(--blue); font-weight: bold; }

        /* === ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© === */
        @media print {
            @page {
                margin: 0.5cm !important;
                size: auto;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white !important;
                color: black !important;
                font-size: 12pt;
                line-height: 1.4;
            }
            
            /* Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .bottom-nav, 
            header, 
            .action-grid, 
            .btn-full, 
            .category-scroll, 
            .add-new-btn, 
            .search-container, 
            .modal-overlay, 
            .edit-btn, 
            .short-code, 
            .qty-badge, 
            #toastBox, 
            .style-switcher, 
            .btn-edit-cart,
            #storeFilters,
            .header-top-row,
            .header-icons,
            .bottom-nav {
                display: none !important;
            }
            
            /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ */
            #storeSection, 
            #archiveSection, 
            #debtSection, 
            #statsSection { 
                display: none !important; 
            }
            
            /* Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙ‚Ø· */
            #cartSection { 
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .invoice-box { 
                border: none !important; 
                padding: 0 !important; 
                margin: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                min-height: auto !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† */
            .invoice-box.style-formal,
            .invoice-box.style-thermal,
            .invoice-box.style-simple {
                background: white !important;
                color: black !important;
                border: 1px solid #ccc !important;
            }
            
            /* Ø¬Ø¹Ù„ Ø§Ù„Ø³Ø¹Ø± Ø£Ø³ÙˆØ¯ Ø¨Ø¯ÙˆÙ† Ø®Ø· */
            .editable-price { 
                text-decoration: none !important; 
                color: black !important;
                font-weight: bold !important;
            }
            
            /* Ø¬Ø¹Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† ØªØ¨Ø¯Ùˆ ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .customer-info-item {
                cursor: default !important;
            }
            .customer-info-value {
                text-decoration: none !important;
                color: black !important;
                font-weight: bold !important;
            }
            .customer-info-value.empty {
                color: #666 !important;
                font-style: italic !important;
            }
            .customer-info-separator {
                background-color: #999 !important;
            }
            
            /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
            .invoice-table {
                width: 100% !important;
                font-size: 11pt !important;
                border-collapse: collapse !important;
            }
            
            .invoice-table th,
            .invoice-table td {
                padding: 5px 3px !important;
                border: 1px solid #ddd !important;
            }
            
            .invoice-table th {
                background: #f0f0f0 !important;
                color: black !important;
                font-weight: bold !important;
            }
            
            /* Ø¥Ø²Ø§Ù„Ø© Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
            body::before,
            body::after {
                display: none !important;
            }
            
            /* Ù…Ù†Ø¹ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØµÙØ­Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù‡Ù…Ø© */
            .shop-header,
            .invoice-table {
                page-break-inside: avoid;
            }
            
            /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .shop-header h2 {
                font-size: 16pt !important;
            }
            
            .shop-header p {
                font-size: 10pt !important;
            }
            
            #grandTotalBox {
                border: 2px solid black !important;
                background: #f9f9f9 !important;
                color: black !important;
                margin-top: 20px !important;
                padding: 15px !important;
            }
            
            /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
            .invoice-table td:last-child {
                display: none !important;
            }
            
            /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
            .btn-edit-cart {
                display: none !important;
            }
            
            /* Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨ÙˆØ¶ÙˆØ­ */
            #invoiceNum,
            #invoiceDate {
                font-weight: bold !important;
                font-size: 11pt !important;
            }
        }
        
        /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 400px) {
            .customer-info-label {
                font-size: 0.8rem;
                margin-left: 5px;
            }
            .customer-info-value {
                font-size: 0.8rem;
            }
            .customer-info-separator {
                margin: 0 5px;
            }
            .header-icons {
                gap: 10px;
            }
        }
    </style>
</head>
<body class="dark-mode">

    <header>
        <div class="header-top-row">
            <div class="header-icons">
                <button class="header-btn" onclick="toggleGlobalLock()">
                    <span id="lockIcon" class="lock-status-closed">ğŸ”’</span>
                </button>
                <button class="header-btn" onclick="showLowStockAlerts()" id="bellBtn">
                    ğŸ””<span id="bellBadge" class="bell-badge" style="display:none">0</span>
                </button>
            </div>
            <h1>Ø£Ø¨Ùˆ Ø­Ø³Ù† Ù„Ù„Ø­Ø¯ÙŠØ¯</h1>
            <div style="display:flex; gap:10px;">
                <button class="header-btn" onclick="toggleDarkMode()" id="darkModeToggle">
                    â˜€ï¸
                </button>
                <button class="header-btn" id="searchToggleBtn" onclick="toggleSearchBox()">ğŸ”</button>
                <button class="header-btn" onclick="secureAccess(openSettings)">âš™ï¸</button>
            </div>
        </div>

        <div id="storeFilters">
            <div class="category-scroll" id="categoryTabs"></div>
            <div class="search-wrapper">
                <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." onkeyup="debouncedFilterProducts()">
            </div>
        </div>
    </header>

    <div class="content-area" id="mainContent">
        <div id="storeSection">
            <div class="products-grid" id="productsGrid"></div>
            <button class="btn btn-full" style="background: #636e72; border: 2px dashed #888; color:#ccc" onclick="openAddModal()">
                + Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </button>
        </div>

        <div id="cartSection" style="display:none;">
            <div class="style-switcher">
                <div class="style-btn active" onclick="setInvoiceStyle('formal', this)">Ø±Ø³Ù…ÙŠ ğŸ“„</div>
                <div class="style-btn" onclick="setInvoiceStyle('thermal', this)">Ø­Ø±Ø§Ø±ÙŠ ğŸ§¾</div>
                <div class="style-btn" onclick="setInvoiceStyle('simple', this)">Ø¨Ø³ÙŠØ· âœ¨</div>
            </div>

            <div class="invoice-box style-formal" id="invoiceToSave">
                <div class="shop-header">
                    <h2 style="margin:0;">Ø£Ø¨Ùˆ Ø­Ø³Ù† Ù„Ù„Ø­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</h2>
                    <p style="margin:5px; font-size:0.9rem; font-weight:bold;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† - Ø§Ù„Ø´Ø¹Ø¨ - Ø´Ø§Ø±Ø¹ Ø§Ù„ØµØ­Ø© - Ù…Ù‚Ø§Ø¨ÙŠÙ„ Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø­Ù‚</p>
                    <p style="font-size:0.9rem; font-weight:bold;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: <span id="phoneDisplay"></span></p>
                    
                    <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.8rem; font-weight:bold;">
                        <span>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <span id="invoiceNum"></span></span>
                        <span id="invoiceDate"></span>
                    </div>
                    
                    <!-- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ…ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„ØªÙƒÙˆÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø± -->
                    <div class="customer-info-row">
                        <div class="customer-info-item" onclick="openEditCustomerName()">
                            <span class="customer-info-label">Ø­Ø¶Ø±Ø© Ø§Ù„Ø³ÙŠØ¯:</span>
                            <span id="customerNameDisplay" class="customer-info-value empty">Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ©</span>
                        </div>
                        
                        <div class="customer-info-separator"></div>
                        
                        <div class="customer-info-item" onclick="openEditCustomerPhone()">
                            <span class="customer-info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                            <span id="customerPhoneDisplay" class="customer-info-value empty">Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ©</span>
                        </div>
                    </div>
                </div>
                
                <table class="invoice-table">
                    <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø¹Ø¯Ø¯</th><th>Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr></thead>
                    <tbody id="cartItems"></tbody>
                </table>
                
                <div id="grandTotalBox" style="background:#eee; padding:10px; text-align:center; font-weight:bold; margin-top:15px; border-radius:5px;">
                    <div id="invoiceCalculations"></div>
                </div>
                
                <button class="btn btn-edit btn-edit-cart" style="width:100%; margin-top:5px; padding:8px; font-size:0.8rem;" onclick="openDiscountModal()">ğŸ’² Ø®ØµÙ… / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>

                <div class="invoice-footer-note" id="invFooterText"></div>
            </div>

            <div class="action-grid">
                <button class="btn btn-print" onclick="initiateCheckout('print')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn btn-image" onclick="initiateCheckout('image')">ğŸ“¸ ØµÙˆØ±Ø©</button>
                <button class="btn btn-wa" onclick="initiateCheckout('whatsapp')">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
                <button class="btn btn-clear" onclick="openClearModal()">ğŸ—‘ï¸ ØªÙØ±ÙŠØº</button>
            </div>
        </div>

        <div id="debtSection" style="display:none;">
            <div class="search-wrapper" style="margin-bottom:10px;">
                <input type="text" id="debtSearch" class="search-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø²Ø¨ÙˆÙ†..." onkeyup="renderDebts()">
            </div>
            <h3 style="text-align:center; color:var(--red); margin-top:0;">Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
            <div id="debtList"></div>
            <button class="btn btn-delete" style="width:100%; margin-top:15px;" onclick="secureAccess(clearDebts)">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ†</button>
        </div>

        <div id="archiveSection" style="display:none;">
            <h3 style="text-align:center; color:var(--accent)">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
            <button class="btn btn-delete" style="width:100%; margin-bottom:10px;" onclick="secureAccess(clearArchive)">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„</button>
            <div id="archiveList"></div>
        </div>

        <div id="statsSection" style="display:none;">
            <h3 style="text-align:center; color:var(--yellow)">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    <div class="stat-val" id="statToday">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</div>
                    <div class="stat-val" style="color:var(--green)" id="statProfit">0</div>
                </div>
            </div>
            <div class="stat-box" style="margin-bottom:10px;">
                <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
                    <div class="stat-val" id="statMonth">0</div>
            </div>
            <div class="stat-box" style="margin-bottom:10px;">
                <div class="stat-label">Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
                <div class="stat-val" style="color:var(--red)" id="statDebtTotal">0</div>
            </div>
            
            <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
            <div class="chart-container">
                <h4 style="text-align:center; margin-bottom:10px;">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h4>
                <canvas id="salesChart" width="400" height="200"></canvas>
            </div>
            
            <h4 style="text-align:center; margin-bottom:10px;">Ø£ÙƒØ«Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ø¨ÙŠØ¹Ø§Ù‹</h4>
            <div id="topProductsList"></div>
            <button class="btn btn-delete" style="width:100%; margin-top:15px; margin-bottom:10px;" onclick="secureAccess(resetStats)">ğŸ—‘ï¸ ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button class="btn btn-full" style="background:#444" onclick="switchTab('store')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ø®Ø²Ù†</button>
        </div>

        <div id="toastBox"></div>

        <div class="modal-overlay" id="mainModal" onclick="closeModalOnOverlay(event)">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal()">Ã—</button>
                <h3 id="modalTitle" style="margin-top:10px;"></h3>
                <div id="modalBody"></div>
            </div>
        </div>

        <div class="modal-overlay" id="confirmModal" onclick="closeConfirmOnOverlay(event)">
            <div class="modal-content" style="border: 2px solid var(--red);">
                <div style="font-size:3rem;">âš ï¸</div>
                <h3 style="margin-top:10px;">ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…!</h3>
                <p id="confirmMessage" style="margin:15px 0;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
                <div class="confirm-actions">
                    <button id="btnConfirmYes" class="confirm-btn confirm-yes">Ù†Ø¹Ù…ØŒ Ù…ØªØ£ÙƒØ¯</button>
                    <button onclick="closeConfirm()" class="confirm-btn confirm-no">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav" id="bottomNavBar">
            <div class="nav-item active" onclick="switchTab('store')" id="tab-store"><span class="nav-icon">ğŸ“¦</span>Ø§Ù„Ù…Ø®Ø²Ù†</div>
            <div class="nav-item" onclick="switchTab('cart')" id="tab-cart"><span class="nav-icon">ğŸ›’</span>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (<span id="cartBadge">0</span>)</div>
            <div class="nav-item" onclick="secureAccess(()=>switchTab('debt'))" id="tab-debt"><span class="nav-icon">ğŸ“’</span>Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
            <div class="nav-item" onclick="secureAccess(()=>switchTab('archive'))" id="tab-archive"><span class="nav-icon">ğŸ“œ</span>Ø§Ù„Ø³Ø¬Ù„</div>
            <div class="nav-item" onclick="secureAccess(()=>switchTab('stats'))" id="tab-stats"><span class="nav-icon">ğŸ“Š</span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        </div>

    <script>
        // === IndexedDB Configuration ===
        let db;
        const DB_NAME = 'abuhassan_db';
        const DB_VERSION = 5;
        
        // === Ø¯Ø§Ù„Ø© Hashing Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256 ===
        async function hashPassword(password) {
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø¨Ø§ÙŠØªØ§Øª
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Crypto API Ù„Ø¥Ù†Ø´Ø§Ø¡ hash SHA-256
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            // ØªØ­ÙˆÙŠÙ„ Hash buffer Ø¥Ù„Ù‰ Ø³Ù„Ø³Ù„Ø© Ù†ØµÙŠØ© hex
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            return hashHex;
        }
        
        // === Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ===
        async function verifyPassword(inputPassword, storedHash) {
            try {
                const inputHash = await hashPassword(inputPassword);
                return inputHash === storedHash;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ:', error);
                return false;
            }
        }
        
        // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø´ÙØ± (Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ù„Ù€ "0000")
        const DEFAULT_PIN_HASH = "4a7d1ed414474e4033ac29ccb8653d9b";

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                // Check if IndexedDB is supported
                if (!window.indexedDB) {
                    reject(new Error("IndexedDB ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­"));
                    return;
                }
                
                try {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onerror = (e) => {
                        // Try to get more specific error information
                        let errorMsg = "ÙØ´Ù„ ÙÙŠ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
                        if (e.target && e.target.error) {
                            errorMsg = `Ø®Ø·Ø£ ÙÙŠ IndexedDB: ${e.target.error.name}`;
                        }
                        reject(new Error(errorMsg));
                    };
                    
                    request.onsuccess = () => {
                        db = request.result;
                        resolve(db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const oldVersion = event.oldVersion || 0;
                        
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                        if (!db.objectStoreNames.contains('products')) {
                            const store = db.createObjectStore('products', { keyPath: 'id' });
                            store.createIndex('code', 'code', { unique: true });
                            store.createIndex('cat', 'cat');
                        }
                        
                        // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†
                        if (db.objectStoreNames.contains('cart')) {
                            db.deleteObjectStore('cart');
                        }
                        
                        if (!db.objectStoreNames.contains('archive')) {
                            const store = db.createObjectStore('archive', { keyPath: 'id' });
                            store.createIndex('date', 'date');
                            store.createIndex('customer', 'customer');
                        }
                        
                        if (!db.objectStoreNames.contains('debts')) {
                            const store = db.createObjectStore('debts', { keyPath: 'id' });
                            store.createIndex('name', 'name');
                        }
                        
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('lowStockAlerts')) {
                            db.createObjectStore('lowStockAlerts', { keyPath: 'id', autoIncrement: true });
                        }
                        
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ…ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        if (oldVersion < 4) {
                            if (db.objectStoreNames.contains('cart')) {
                                db.deleteObjectStore('cart');
                            }
                        }
                    };
                } catch (error) {
                    reject(new Error(`Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© IndexedDB: ${error.message}`));
                }
            });
        }
        
        // === Database Operations ===
        async function dbGetAll(storeName) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        async function dbAdd(storeName, data) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.add(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        async function dbPut(storeName, data) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        async function dbDelete(storeName, id) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        async function dbClear(storeName) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // === Global Variables ===
        let products = [];
        let cart = []; // Ø¯Ø§Ø¦Ù…Ø§Ù‹ ØªØ¨Ø¯Ø£ ÙØ§Ø±ØºØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        let archive = [];
        let debts = [];
        let lowStockAlerts = [];
        let settings = { 
            id: 1, 
            phone: "07700873460", 
            pinHash: DEFAULT_PIN_HASH, // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø´ÙØ± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
            footer: "Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ù„Ø§ ØªØ±Ø¯ ÙˆÙ„Ø§ ØªØ³ØªØ¨Ø¯Ù„ Ø¥Ù„Ø§ Ø¨Ø¹Ø°Ø± Ø´Ø±Ø¹ÙŠ", 
            darkMode: true 
        };
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†
        let customerName = "";
        let customerPhone = "";

        let activeCategory = "Ø§Ù„ÙƒÙ„";
        let pendingAction = null; 
        let isGlobalUnlocked = false; 
        let touchStartX = 0; 
        let pressTimer;
        let isLongPress = false;
        let actionDone = false; 
        let startTouchX = 0;
        let startTouchY = 0;
        let isScrolling = false; 
        let lastTouchTime = 0; 
        let pendingConfirmAction = null;
        let invoiceDiscount = 0;
        let salesChart = null;
        let isFirstLoad = true; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØµÙØ­Ø©
        
        // === Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« ===
        let searchTimeout = null;
        let allProductCards = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª

        // === Load Data from IndexedDB ===
        async function loadAllData() {
            try {
                // Load products
                products = await dbGetAll('products');
                if (products.length === 0) {
                    // Add default products
                    const defaultProducts = [
                        {id: 1, name: "Ø´ÙŠØ´ 12 Ù…Ù„Ù…", price: 15000, cost: 13000, stock: 100, cat: "Ø´ÙŠØ´", code: "A1"},
                        {id: 2, name: "Ø²Ø§ÙˆÙŠØ© 2 Ø§Ù†Ø¬", price: 8000, cost: 6000, stock: 50, cat: "Ø²ÙˆØ§ÙŠØ§", code: "B1"}
                    ];
                    for (const prod of defaultProducts) {
                        await dbAdd('products', prod);
                    }
                    products = defaultProducts;
                }
                
                // Ù„Ø§ Ù†Ø­Ù…Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ØªØ¨Ø¯Ø£ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙØ§Ø±ØºØ©
                cart = [];
                
                // Load archive
                archive = await dbGetAll('archive');
                
                // Load debts
                debts = await dbGetAll('debts');
                
                // Load settings
                const settingsArray = await dbGetAll('settings');
                if (settingsArray.length > 0) {
                    settings = settingsArray[0];
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø®Ø²Ù†Ø§Ù‹ ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ hash
                    if (settings.pin && !settings.pinHash) {
                        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù„Ù‰ hash
                        settings.pinHash = await hashPassword(settings.pin);
                        delete settings.pin; // Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù‚Ø¯ÙŠÙ…
                        await dbPut('settings', settings); // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                    }
                    
                    // Apply dark mode setting Ù…Ø¹ Ø¹ÙƒØ³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                    document.body.className = settings.darkMode ? 'dark-mode' : 'light-mode';
                    // Ø¹ÙƒØ³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©: ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù…Ø³ØŒ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ù„Ø§Ù„
                    document.getElementById('darkModeToggle').innerText = settings.darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
                } else {
                    await dbAdd('settings', settings);
                }
                
                // Check low stock
                await checkLowStock();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù„ÙŠØ¹ÙƒØ³ Ø£Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©
                updateCartUI();
                filterProducts();
                
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                return false;
            }
        }
        
        // === Save Data to IndexedDB ===
        async function saveAll() {
            try {
                // Save products
                await dbClear('products');
                for (const prod of products) {
                    await dbAdd('products', prod);
                }
                
                // Ù„Ø§ Ù†Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†
                
                // Save archive
                await dbClear('archive');
                for (const arch of archive) {
                    await dbAdd('archive', arch);
                }
                
                // Save debts
                await dbClear('debts');
                for (const debt of debts) {
                    await dbAdd('debts', debt);
                }
                
                // Save settings
                await dbPut('settings', settings);
                
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                return false;
            }
        }

        // === PWA Initialization ===
        function initPWA() {
            const manifest = { 
                "name": "Ø£Ø¨Ùˆ Ø­Ø³Ù† Ù„Ù„Ø­Ø¯ÙŠØ¯", 
                "short_name": "Ø£Ø¨Ùˆ Ø­Ø³Ù†", 
                "start_url": ".", 
                "display": "standalone", 
                "background_color": "#1e272e", 
                "theme_color": "#1e272e", 
                "icons": [ 
                    { 
                        "src": "https://cdn-icons-png.flaticon.com/512/2554/2554039.png", 
                        "sizes": "192x192", 
                        "type": "image/png" 
                    } 
                ] 
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.querySelector('#my-manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        }

        // === Customer Display Functions ===
        function updateCustomerDisplay() {
            const nameDisplay = document.getElementById('customerNameDisplay');
            const phoneDisplay = document.getElementById('customerPhoneDisplay');
            
            if (customerName && customerName.trim() !== "") {
                nameDisplay.textContent = customerName;
                nameDisplay.className = "customer-info-value";
            } else {
                nameDisplay.textContent = "Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ©";
                nameDisplay.className = "customer-info-value empty";
            }
            
            if (customerPhone && customerPhone.trim() !== "") {
                phoneDisplay.textContent = customerPhone;
                phoneDisplay.className = "customer-info-value";
            } else {
                phoneDisplay.textContent = "Ø§Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ©";
                phoneDisplay.className = "customer-info-value empty";
            }
        }

        function openEditCustomerName() {
            showModal('Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†', `
                <input type="text" id="editCustomerNameInput" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" value="${customerName}">
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-print" style="flex:1" onclick="saveCustomerName()">Ø­ÙØ¸</button>
                    <button class="btn btn-delete" style="flex:1" onclick="clearCustomerName()">Ù…Ø³Ø­</button>
                </div>
            `);
        }

        function saveCustomerName() {
            const newName = document.getElementById('editCustomerNameInput').value.trim();
            customerName = newName;
            updateCustomerDisplay();
            closeModal();
            if (newName) {
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†');
            }
        }

        function clearCustomerName() {
            customerName = "";
            updateCustomerDisplay();
            closeModal();
            showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†');
        }

        function openEditCustomerPhone() {
            showModal('Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†', `
                <input type="tel" id="editCustomerPhoneInput" class="modal-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${customerPhone}">
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-print" style="flex:1" onclick="saveCustomerPhone()">Ø­ÙØ¸</button>
                    <button class="btn btn-delete" style="flex:1" onclick="clearCustomerPhone()">Ù…Ø³Ø­</button>
                </div>
            `);
        }

        function saveCustomerPhone() {
            const newPhone = document.getElementById('editCustomerPhoneInput').value.trim();
            customerPhone = newPhone;
            updateCustomerDisplay();
            closeModal();
            if (newPhone) {
                showToast('ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
            }
        }

        function clearCustomerPhone() {
            customerPhone = "";
            updateCustomerDisplay();
            closeModal();
            showToast('ØªÙ… Ù…Ø³Ø­ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
        }

        // === Dark Mode Toggle ===
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                // Ø¹ÙƒØ³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©: ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ù„Ø§Ù„
                document.getElementById('darkModeToggle').innerText = 'ğŸŒ™';
                settings.darkMode = false;
            } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                // Ø¹ÙƒØ³ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©: ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù…Ø³
                document.getElementById('darkModeToggle').innerText = 'â˜€ï¸';
                settings.darkMode = true;
            }
            saveAll();
            
            // Update chart if exists
            if (salesChart) {
                initSalesChart();
            }
        }

        // === Low Stock Alerts - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† 0 ===
        async function checkLowStock() {
            try {
                // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±Ø· Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† 0 ÙˆØ£ÙŠØ¶Ø§Ù‹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ 5
                const lowStockProducts = products.filter(p => p.stock <= 5);
                const bellBtn = document.getElementById('bellBtn');
                const bellBadge = document.getElementById('bellBadge');
                
                if (lowStockProducts.length > 0) {
                    bellBtn.classList.add('bell-alert');
                    bellBadge.textContent = lowStockProducts.length;
                    bellBadge.style.display = 'flex';
                    
                    // Save alerts
                    await dbClear('lowStockAlerts');
                    for (const prod of lowStockProducts) {
                        await dbAdd('lowStockAlerts', {
                            productId: prod.id,
                            productName: prod.name,
                            currentStock: prod.stock,
                            alertDate: new Date().toLocaleString()
                        });
                    }
                    lowStockAlerts = lowStockProducts.map(prod => ({
                        productId: prod.id,
                        productName: prod.name,
                        currentStock: prod.stock,
                        alertDate: new Date().toLocaleString()
                    }));
                } else {
                    bellBtn.classList.remove('bell-alert');
                    bellBadge.style.display = 'none';
                    lowStockAlerts = [];
                }
            } catch (error) {
                console.error('Error checking low stock:', error);
            }
        }
        
        function showLowStockAlerts() {
            if (lowStockAlerts.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø£Ùˆ Ù†ÙØ°Øª ÙƒÙ„ÙŠØ§Ù‹');
                return;
            }
            
            let alertHTML = '<h4 style="color:var(--yellow); margin-bottom:10px;">Ù…ÙˆØ§Ø¯ Ù…Ø®Ø²ÙˆÙ†Ù‡Ø§ Ù…Ù†Ø®ÙØ¶ Ø£Ùˆ Ù†ÙØ°Øª:</h4>';
            alertHTML += '<div style="max-height:200px; overflow-y:auto;">';
            
            lowStockAlerts.forEach(alert => {
                const stockColor = alert.currentStock === 0 ? 'var(--red)' : (alert.currentStock <= 2 ? 'var(--yellow)' : 'var(--green)');
                alertHTML += `
                    <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #444;">
                        <span>${alert.productName}</span>
                        <span style="color:${stockColor}; font-weight:bold;">
                            ${alert.currentStock === 0 ? 'Ù†ÙØ°Øª' : `${alert.currentStock} Ù‚Ø·Ø¹`}
                        </span>
                    </div>
                `;
            });
            
            alertHTML += '</div>';
            
            showModal('ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶ Ø£Ùˆ Ø§Ù„Ù†ÙØ§Ø°', alertHTML);
        }

        // === Sales Chart ===
        function initSalesChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;
            
            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (salesChart) {
                try {
                    salesChart.destroy();
                } catch (e) {
                    console.log('Error destroying previous chart:', e);
                }
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
            const last7Days = [];
            const salesData = [];
            
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = formatDate(date);
                last7Days.push(dateStr);
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
                let daySales = 0;
                for (const a of archive) {
                    try {
                        if (a.date && isSameDay(new Date(a.date), date)) {
                            daySales += a.total || 0;
                        }
                    } catch (e) {
                        console.log('Error processing archive item:', e);
                    }
                }
                
                salesData.push(daySales);
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹
            const isDarkMode = document.body.classList.contains('dark-mode');
            const bgColor = isDarkMode ? '#2d3436' : '#ffffff';
            const textColor = isDarkMode ? '#dfe6e9' : '#333333';
            const gridColor = isDarkMode ? '#4d5861' : '#e0e0e0';
            const pointColor = isDarkMode ? '#e17055' : '#e17055';
            const lineColor = isDarkMode ? '#00b894' : '#00b894';
            
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                            data: salesData,
                            borderColor: lineColor,
                            backgroundColor: `${lineColor}20`,
                            pointBackgroundColor: pointColor,
                            pointBorderColor: bgColor,
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: textColor,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    color: gridColor
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000) {
                                            return (value/1000).toFixed(0) + 'K';
                                        }
                                        return value;
                                    }
                                },
                                grid: {
                                    color: gridColor
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating chart:', error);
            }
        }

        // === Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ===
        function formatDate(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            return `${day}/${month}`;
        }

        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }

        function getTodayDateString() {
            const today = new Date();
            return `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
        }

        // === Ø¯Ø§Ù„Ø© Debounce Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« ===
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // === Initialize App ===
        window.onload = async function() {
            initPWA();
            
            try {
                // Initialize IndexedDB
                await initDB();
                
                // Load all data
                await loadAllData();
                
                // Initialize UI
                document.getElementById('invoiceNum').innerText = Math.floor(Math.random()*9000)+1000;
                document.getElementById('phoneDisplay').innerText = settings.phone;
                document.getElementById('invFooterText').innerText = settings.footer;
                updateCustomerDisplay();
                updateTime(); 
                setInterval(updateTime, 1000);
                renderCategories();
                filterProducts();
                
                // Initialize touch events
                const content = document.getElementById('mainContent');
                content.addEventListener('touchstart', e => { 
                    touchStartX = e.changedTouches[0].screenX; 
                }, {passive: true});
                content.addEventListener('touchend', e => { 
                    handleSwipe(e.changedTouches[0].screenX); 
                }, {passive: true});
                
                // Check low stock on startup
                await checkLowStock();
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
                setupBackButtonHandler();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                isFirstLoad = false;
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø¨ÙŠØ¦Ø© ØªØ¯Ø¹Ù… IndexedDB');
                
                // Ù†Ø³ØªÙ…Ø± Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                products = [
                    {id: 1, name: "Ø´ÙŠØ´ 12 Ù…Ù„Ù…", price: 15000, cost: 13000, stock: 100, cat: "Ø´ÙŠØ´", code: "A1"},
                    {id: 2, name: "Ø²Ø§ÙˆÙŠØ© 2 Ø§Ù†Ø¬", price: 8000, cost: 6000, stock: 50, cat: "Ø²ÙˆØ§ÙŠØ§", code: "B1"}
                ];
                cart = [];
                archive = [];
                debts = [];
                
                document.getElementById('invoiceNum').innerText = Math.floor(Math.random()*9000)+1000;
                document.getElementById('phoneDisplay').innerText = settings.phone;
                document.getElementById('invFooterText').innerText = settings.footer;
                updateCustomerDisplay();
                updateTime(); 
                setInterval(updateTime, 1000);
                renderCategories();
                filterProducts();
            }
        };

        // === Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Debounce ===
        const debouncedFilterProducts = debounce(filterProducts, 300);

        // === Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ===
        function setupBackButtonHandler() {
            // Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ù„Ø²Ø± Ø§Ù„Ø®Ù„ÙÙŠ ÙÙŠ Ø§Ù„Ù‡ÙˆØ§ØªÙ
            window.addEventListener('popstate', function(event) {
                handleBackButton();
            });
            
            // Ø£ÙŠØ¶Ù‹Ø§ Ù†Ø¶ÙŠÙ Ù…Ø³ØªÙ…Ø¹ Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù‡Ø±ÙˆØ¨ (Escape) Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    handleBackButton();
                }
            });
        }

        function handleBackButton() {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ù†ØºÙ„Ù‚Ù‡Ø§
            if (document.getElementById('mainModal').style.display === 'flex') {
                closeModal();
                return;
            }
            
            if (document.getElementById('confirmModal').style.display === 'flex') {
                closeConfirm();
                return;
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ù†Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù† Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠÙ‡
            const currentTab = ['store','cart','debt','archive','stats'].find(t => 
                document.getElementById(t+'Section').style.display !== 'none');
            
            if (currentTab && currentTab !== 'store') {
                switchTab('store');
            }
        }

        function updateTime() { 
            document.getElementById('invoiceDate').innerText = new Date().toLocaleString('ar-IQ'); 
        }
        
        function showToast(msg) {
            const box = document.getElementById('toastBox');
            const div = document.createElement('div');
            div.className = 'toast'; 
            div.innerText = msg;
            box.appendChild(div); 
            setTimeout(() => div.remove(), 3000);
        }

        function handleSwipe(endX) {
            const diff = endX - touchStartX;
            if (Math.abs(diff) < 50) return; 
            const tabs = ['store', 'cart', 'debt', 'archive', 'stats'];
            let currentIdx = tabs.findIndex(t => document.getElementById(t+'Section').style.display !== 'none');
            if(currentIdx === -1) return;
            if (diff > 0) { 
                if (currentIdx < 4) {
                    const target = tabs[currentIdx + 1];
                    if(target === 'debt' || target === 'archive' || target === 'stats') secureAccess(()=>switchTab(target)); 
                    else switchTab(target);
                }
            } else { 
                 if (currentIdx > 0) { 
                    const target = tabs[currentIdx - 1];
                    if(target === 'debt' || target === 'archive' || target === 'stats') secureAccess(()=>switchTab(target)); 
                    else switchTab(target);
                }
            }
        }

        function setInvoiceStyle(styleName, btnElement) {
            const box = document.getElementById('invoiceToSave');
            box.classList.remove('style-formal', 'style-thermal', 'style-simple');
            box.classList.add('style-' + styleName);
            document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(20);
        }

        function toggleSearchBox() { 
            document.getElementById('storeFilters').classList.toggle('show'); 
        }

        function switchTab(t) {
            ['store','cart','debt','archive','stats'].forEach(x => document.getElementById(x+'Section').style.display = 'none');
            document.getElementById(t+'Section').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const nav = document.getElementById('tab-'+t); 
            if(nav) nav.classList.add('active');
            const searchBtn = document.getElementById('searchToggleBtn');
            const filters = document.getElementById('storeFilters');
            if (t === 'store') searchBtn.style.display = 'flex';
            else { 
                searchBtn.style.display = 'none'; 
                filters.classList.remove('show'); 
            }
            
            if(t === 'debt') renderDebts();
            
            if(t === 'archive') {
                const list = document.getElementById('archiveList');
                list.innerHTML = archive.map(a => `
                    <div class="product-card" style="text-align:right; margin-bottom:10px; cursor:pointer;" onclick="openArchiveDetails('${a.id}')">
                        <div style="display:flex; justify-content:space-between; color:#aaa; font-size:0.8rem">
                            <span>${a.date}</span>
                            <span>${a.type==='credit'?'Ø¢Ø¬Ù„ ğŸ“’':(a.type==='partial'?'Ø¬Ø²Ø¡ ğŸŒ“':'Ù†Ù‚Ø¯ ğŸ’µ')}</span>
                        </div>
                        <h4 style="margin:5px 0">Ø±Ù‚Ù…: ${a.id} | ${a.customer||'Ø²Ø¨ÙˆÙ† Ù†Ù‚Ø¯ÙŠ'}</h4>
                        <div style="font-weight:bold; color:var(--accent)">${a.total.toLocaleString()} Ø¯.Ø¹</div>
                    </div>
                `).join('') || '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</p>';
            }
            
            if(t === 'stats') {
                openStats();
            }
        }

        function openEditCartItemPrice(idx) {
            const item = cart[idx];
            showModal(`ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø±: ${item.name}`, `
                <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${item.price.toLocaleString()}</p>
                <input type="number" id="newPriceInput" class="modal-input" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯" value="${item.price}">
                <button class="btn btn-print" style="width:100%;" onclick="saveCartItemPrice(${idx})">Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø±</button>
            `);
        }

        function saveCartItemPrice(idx) {
            const newPrice = parseInt(document.getElementById('newPriceInput').value);
            if(newPrice >= 0) {
                cart[idx].price = newPrice;
                updateCartUI();
                closeModal();
                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª
                // showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¹Ø±');
            }
        }

        function openDiscountModal() {
            if(cart.length === 0) return showToast('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©');
            let total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            showModal('Ø®ØµÙ… / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', `
                <p>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${total.toLocaleString()}</p>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button id="btnDiscAmount" class="btn btn-print" style="flex:1" onclick="switchDiscMode('amount')">Ø®ØµÙ… Ù…Ø¨Ù„Øº</button>
                    <button id="btnDiscTotal" class="btn btn-image" style="flex:1; opacity:0.5" onclick="switchDiscMode('total')">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</button>
                </div>
                <input type="hidden" id="discType" value="amount">
                <input type="number" id="discInput" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="numeric">
                <button class="btn btn-add" style="width:100%;" onclick="applyDiscount(${total})">ØªØ·Ø¨ÙŠÙ‚</button>
            `);
        }

        function switchDiscMode(mode) {
            const btnAmount = document.getElementById('btnDiscAmount');
            const btnTotal = document.getElementById('btnDiscTotal');
            const hiddenInput = document.getElementById('discType');
            hiddenInput.value = mode;
            if (mode === 'amount') { 
                btnAmount.style.opacity = '1'; 
                btnTotal.style.opacity = '0.5'; 
            } else { 
                btnAmount.style.opacity = '0.5'; 
                btnTotal.style.opacity = '1'; 
            }
        }

        function applyDiscount(currentTotal) {
            const type = document.getElementById('discType').value;
            const val = parseInt(document.getElementById('discInput').value);
            if(!val || val < 0) return;
            if(type === 'amount') { 
                invoiceDiscount = val; 
            } else { 
                if(val > currentTotal) return showToast('Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹!'); 
                invoiceDiscount = currentTotal - val; 
            }
            updateCartUI(); 
            closeModal();
        }

        function updateCartUI() {
            const tbody = document.getElementById('cartItems');
            tbody.innerHTML = '';
            let subTotal = 0;
            cart.forEach((item, idx) => {
                const rowTotal = item.price * item.qty;
                subTotal += rowTotal;
                tbody.innerHTML += `
                    <tr>
                        <td style="text-align:right">${item.name}</td>
                        <td>${item.qty}</td>
                        <td class="editable-price" onclick="openEditCartItemPrice(${idx})">${item.price.toLocaleString()}</td>
                        <td>${rowTotal.toLocaleString()}</td>
                        <td><button class="btn btn-delete" style="padding:5px 10px; font-size:0.8rem;" ontouchstart="handleTouchStart(event, 'delete', ${idx})" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event, 'delete', ${idx})" onmousedown="handleTouchStart(event, 'delete', ${idx})" onmouseup="handleTouchEnd(event, 'delete', ${idx})" onmouseleave="clearTimeout(pressTimer)">âœ•</button></td>
                    </tr>
                `;
            });

            if(invoiceDiscount > subTotal) invoiceDiscount = subTotal;
            const finalTotal = subTotal - invoiceDiscount;

            let totalHtml = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${finalTotal.toLocaleString()} Ø¯.Ø¹`;
            if(invoiceDiscount > 0) {
                totalHtml = `<span style="font-size:0.8rem; color:#666; text-decoration:line-through;">${subTotal.toLocaleString()}</span><br>
                             <span style="font-size:0.9rem; color:var(--red);">Ø®ØµÙ…: ${invoiceDiscount.toLocaleString()}-</span><br>
                             <span style="font-size:1.1rem;">Ø§Ù„ØµØ§ÙÙŠ: ${finalTotal.toLocaleString()} Ø¯.Ø¹</span>`;
            }
            document.getElementById('invoiceCalculations').innerHTML = totalHtml;
            document.getElementById('cartBadge').innerText = cart.length;
        }

        function handleTouchStart(e, type, idOrIdx) {
            lastTouchTime = new Date().getTime();
            if (e.touches && e.touches.length > 0) { 
                startTouchX = e.touches[0].clientX; 
                startTouchY = e.touches[0].clientY; 
            } else { 
                if (new Date().getTime() - lastTouchTime < 500) return; 
                startTouchX = e.clientX; 
                startTouchY = e.clientY; 
            }
            isScrolling = false; 
            isLongPress = false; 
            actionDone = false;
            pressTimer = setTimeout(() => { 
                if (!isScrolling) { 
                    isLongPress = true; 
                    actionDone = true; 
                    if(type === 'delete') remAllItem(idOrIdx); 
                    if(type === 'add') openQtyModal(idOrIdx); 
                } 
            }, 600);
        }

        function handleTouchMove(e) {
            let moveX, moveY;
            if (e.touches && e.touches.length > 0) { 
                moveX = e.touches[0].clientX; 
                moveY = e.touches[0].clientY; 
            } else { 
                moveX = e.clientX; 
                moveY = e.clientY; 
            }
            if (Math.abs(moveX - startTouchX) > 10 || Math.abs(moveY - startTouchY) > 10) { 
                isScrolling = true; 
                clearTimeout(pressTimer); 
            }
        }

        function handleTouchEnd(e, type, idOrIdx) {
            clearTimeout(pressTimer);
            if (e.type === 'touchend' && e.cancelable) e.preventDefault(); 
            else if (new Date().getTime() - lastTouchTime < 500) return;
            if (!isScrolling && !isLongPress && !actionDone) { 
                actionDone = true; 
                if(type === 'delete') remItem(idOrIdx); 
                if(type === 'add') addToCart(idOrIdx, 1); 
            }
        }

        function showConfirm(msg, action) {
            document.getElementById('confirmMessage').innerText = msg;
            pendingConfirmAction = action;
            document.getElementById('confirmModal').style.display = 'flex';
            document.getElementById('btnConfirmYes').onclick = function() { 
                if(pendingConfirmAction) pendingConfirmAction(); 
                closeConfirm(); 
            };
        }

        function closeConfirm() { 
            document.getElementById('confirmModal').style.display = 'none'; 
            pendingConfirmAction = null; 
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        function closeConfirmOnOverlay(event) {
            if (event.target.id === 'confirmModal') {
                closeConfirm();
            }
        }

        async function clearArchive() { 
            showConfirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ', async () => { 
                archive = []; 
                await dbClear('archive');
                await saveAll(); 
                switchTab('archive'); 
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); 
            }); 
        }
        
        async function clearDebts() { 
            showConfirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ†ØŸ', async () => { 
                debts = []; 
                await dbClear('debts');
                await saveAll(); 
                renderDebts(); 
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); 
            }); 
        }

        async function remAllItem(idx) { 
            if(navigator.vibrate) navigator.vibrate(50); 
            
            // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù‚Ø¨Ù„ Ø­Ø°ÙÙ‡
            const item = cart[idx];
            const productId = item.id;
            
            // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            cart.splice(idx, 1); 
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            updateCartUI(); 
            
            // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†
            updateProductCardById(productId);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª
            // showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹'); 
        }
        
        function remItem(idx) { 
            if(cart[idx].qty > 1) { 
                cart[idx].qty--; 
                updateCartUI(); 
                // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†
                updateProductCardById(cart[idx].id);
            } else { 
                const removedItem = cart[idx];
                cart.splice(idx, 1);
                updateCartUI();
                // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
                updateProductCardById(removedItem.id);
            } 
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª
            // showToast('ØªÙ… Ø®ØµÙ… Ù‚Ø·Ø¹Ø©'); 
        }

        function openQtyModal(id) {
            if(navigator.vibrate) navigator.vibrate(50);
            const p = products.find(x => x.id === id);
            const inCart = cart.find(x => x.id === id)?.qty || 0;
            const max = p.stock - inCart;
            if(max <= 0) return showToast('Ø§Ù„ÙƒÙ…ÙŠØ© Ù†Ø§ÙØ°Ø©');
            showModal(`Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ©: ${p.name}`, `<p>Ø§Ù„Ù…ØªÙˆÙØ±: ${max}</p><input type="number" id="qtyInput" class="modal-input" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" inputmode="numeric"><button class="btn btn-add" style="width:100%;" onclick="confirmAddQty(${id}, ${max})">Ø¥Ø¶Ø§ÙØ©</button>`);
        }

        function confirmAddQty(id, max) { 
            const qty = parseInt(document.getElementById('qtyInput').value); 
            if(qty > 0 && qty <= max) { 
                addToCart(id, qty); 
                closeModal(); 
            } else { 
                showToast('Ø§Ù„Ø¹Ø¯Ø¯ Ø®Ø·Ø£'); 
            } 
        }

        async function addToCart(id, qty = 1) {
            const p = products.find(x => x.id === id);
            const item = cart.find(x => x.id === id);
            let priceToUse = item ? item.price : p.price;
            let currentQty = item ? item.qty : 0;
            if (currentQty + qty > p.stock) return showToast('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
            if(item) { 
                item.qty += qty; 
            } else { 
                cart.push({...p, qty: qty, price: priceToUse, originalCost: p.cost || 0}); 
            }
            updateCartUI(); 
            updateProductCardById(id); // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬
            
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª
            // showToast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
        }

        // === Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ù…Ù†ØªØ¬ Ù…Ø¹ÙŠÙ† ===
        function updateProductCardById(productId) {
            const productCard = document.querySelector(`.product-card[data-id="${productId}"]`);
            if (productCard) {
                updateProductCard(productCard);
            }
        }

        // === Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ù…Ù†ØªØ¬ ===
        function updateProductCard(card) {
            const productId = parseInt(card.getAttribute('data-id'));
            const p = products.find(prod => prod.id === productId);
            if (!p) return;

            const inCart = cart.find(x => x.id === productId)?.qty || 0;
            const remaining = p.stock - inCart;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
            const codeClass = inCart > 0 ? 'short-code shifted' : 'short-code';
            
            // Ø­ÙØ¸ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªØ¬Ù†Ø¨ ÙÙ‚Ø¯Ø§Ù†Ù‡Ø§
            const editBtn = card.querySelector('.edit-btn');
            
            card.innerHTML = `
                ${inCart > 0 ? `<div class="qty-badge">${inCart}</div>` : ''}
                <span class="${codeClass}">#${p.code || '---'}</span>
                <button class="edit-btn" onclick="openEditProduct(${p.id}, event)" style="position:absolute; left:0; top:0; background:none; border:none; color:#aaa; padding:10px;">âš™ï¸</button>
                <div style="font-size:1.5rem; margin-top:15px;">ğŸ—ï¸</div>
                <h3 style="margin:5px 0;">${p.name}</h3>
                <div style="color:var(--accent); font-weight:bold;">${p.price.toLocaleString()}</div>
                <span class="${remaining<=0?'stock-out':(remaining<5?'stock-low':'stock-tag')}">${remaining<=0?'Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©':`Ø§Ù„Ù…ØªÙˆÙØ±: ${remaining}`}</span>
            `;

            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±ÙØ§Ù‚ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ù…Ø³ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙƒÙ…ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©
            if (remaining > 0) {
                card.ontouchstart = function(e) { 
                    if(!e.target.closest('.edit-btn')) handleTouchStart(e, 'add', p.id); 
                };
                card.ontouchmove = function(e) { handleTouchMove(e); };
                card.ontouchend = function(e) { 
                    if(!e.target.closest('.edit-btn')) handleTouchEnd(e, 'add', p.id); 
                };
                card.onmousedown = function(e) { 
                    if(!e.target.closest('.edit-btn')) handleTouchStart(e, 'add', p.id); 
                };
                card.onmouseup = function(e) { 
                    if(!e.target.closest('.edit-btn')) handleTouchEnd(e, 'add', p.id); 
                };
                card.onmouseleave = function() { clearTimeout(pressTimer); };
            } else {
                card.ontouchstart = null;
                card.ontouchmove = null;
                card.ontouchend = null;
                card.onmousedown = null;
                card.onmouseup = null;
                card.onmouseleave = null;
            }
        }

        function renderCategories() {
            const cats = ["Ø§Ù„ÙƒÙ„", ...new Set(products.map(p => p.cat || "Ø¹Ø§Ù…"))];
            const container = document.getElementById('categoryTabs');
            container.innerHTML = cats.map(c => `<div class="cat-tab ${c === activeCategory ? 'active' : ''}" onclick="setCategory('${c}')">${c}</div>`).join('');
        }

        function setCategory(c) { 
            activeCategory = c; 
            renderCategories(); 
            filterProducts(); 
        }

        // === Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù†Ø© ===
        function filterProducts() {
            const q = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const grid = document.getElementById('productsGrid');
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ù†Ù†Ø´Ø¦ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            if (allProductCards.length === 0) {
                createAllProductCards();
            }
            
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
            allProductCards.forEach(card => {
                const productName = card.getAttribute('data-name').toLowerCase();
                const productCode = card.getAttribute('data-code').toLowerCase();
                const productCat = card.getAttribute('data-cat') || "Ø¹Ø§Ù…";
                
                const matchSearch = productName.includes(q) || productCode.includes(q);
                const matchCat = activeCategory === "Ø§Ù„ÙƒÙ„" || productCat === activeCategory;
                
                if (matchSearch && matchCat) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬
            const visibleCards = allProductCards.filter(card => !card.classList.contains('hidden'));
            const noResultsMsg = grid.querySelector('.no-results');
            
            if (visibleCards.length === 0) {
                if (!noResultsMsg) {
                    const msg = document.createElement('p');
                    msg.className = 'no-results';
                    msg.style.gridColumn = 'span 2';
                    msg.style.textAlign = 'center';
                    msg.style.color = '#777';
                    msg.textContent = 'Ù…Ø§ÙƒÙˆ Ù…ÙˆØ§Ø¯';
                    grid.appendChild(msg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // === Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ===
        function createAllProductCards() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            allProductCards = []; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµÙÙˆÙØ©
            
            products.forEach(p => {
                const inCart = cart.find(x => x.id === p.id)?.qty || 0;
                const remaining = p.stock - inCart;
                const div = document.createElement('div');
                div.className = 'product-card';
                div.setAttribute('data-name', p.name);
                div.setAttribute('data-code', p.code || '');
                div.setAttribute('data-cat', p.cat || 'Ø¹Ø§Ù…');
                div.setAttribute('data-id', p.id);
                
                const codeClass = inCart > 0 ? 'short-code shifted' : 'short-code';
                div.innerHTML = `
                    ${inCart > 0 ? `<div class="qty-badge">${inCart}</div>` : ''}
                    <span class="${codeClass}">#${p.code || '---'}</span>
                    <button class="edit-btn" onclick="openEditProduct(${p.id}, event)" style="position:absolute; left:0; top:0; background:none; border:none; color:#aaa; padding:10px;">âš™ï¸</button>
                    <div style="font-size:1.5rem; margin-top:15px;">ğŸ—ï¸</div>
                    <h3 style="margin:5px 0;">${p.name}</h3>
                    <div style="color:var(--accent); font-weight:bold;">${p.price.toLocaleString()}</div>
                    <span class="${remaining<=0?'stock-out':(remaining<5?'stock-low':'stock-tag')}">${remaining<=0?'Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©':`Ø§Ù„Ù…ØªÙˆÙØ±: ${remaining}`}</span>
                `;
                
                if (remaining > 0) {
                    div.ontouchstart = function(e) { if(!e.target.closest('.edit-btn')) handleTouchStart(e, 'add', p.id); };
                    div.ontouchmove = function(e) { handleTouchMove(e); };
                    div.ontouchend = function(e) { if(!e.target.closest('.edit-btn')) handleTouchEnd(e, 'add', p.id); };
                    div.onmousedown = function(e) { if(!e.target.closest('.edit-btn')) handleTouchStart(e, 'add', p.id); };
                    div.onmouseup = function(e) { if(!e.target.closest('.edit-btn')) handleTouchEnd(e, 'add', p.id); };
                    div.onmouseleave = function() { clearTimeout(pressTimer); };
                }
                
                grid.appendChild(div);
                allProductCards.push(div);
            });
        }

        function initiateCheckout(action) {
            if(cart.length === 0) return showToast('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©');
            pendingAction = action;
            
            let subTotal = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            let finalTotal = subTotal - invoiceDiscount;
            if(finalTotal < 0) finalTotal = 0;

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… customerName Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            let custName = customerName;
            let custPhone = customerPhone;
            
            if(!custName || custName.trim() === "") custName = "Ø²Ø¨ÙˆÙ† Ù†Ù‚Ø¯ÙŠ"; 

            showModal('Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹', `
                <h2 class="modal-total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${finalTotal.toLocaleString()}</h2>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-print" style="flex:1;" onclick="processPayment('cash')">ğŸ’µ ÙˆØ§ØµÙ„ (Ù†Ù‚Ø¯)</button>
                    <button class="btn btn-delete" style="flex:1;" onclick="processPayment('credit')">ğŸ“’ Ø¢Ø¬Ù„ (Ø¯ÙŠÙ†)</button>
                    <button class="btn btn-partial" style="flex-basis: 100%; margin-top:5px;" onclick="askPartialPayment()">ğŸ—“ï¸ ÙˆØ§ØµÙ„ Ø¬Ø²Ø¡ / Ø¨Ø§Ù‚ÙŠ</button>
                </div>
            `);
        }

        function askPartialPayment() {
            let subTotal = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            let finalTotal = subTotal - invoiceDiscount;
            if(finalTotal < 0) finalTotal = 0;

            showModal('ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¡ (ÙˆØ§ØµÙ„)', `
                <h2 class="modal-total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${finalTotal.toLocaleString()}</h2>
                <input type="number" id="paidAmountInput" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø¯ÙØ¹Ù‡ Ø§Ù„Ø²Ø¨ÙˆÙ†" inputmode="numeric">
                <button class="btn btn-add" style="width:100%;" onclick="processPayment('partial')">Ø­ÙØ¸</button>
            `);
        }

        async function processPayment(type) {
            let subTotal = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            let finalTotal = subTotal - invoiceDiscount;
            if(finalTotal < 0) finalTotal = 0;

            let custName = customerName;
            let custPhone = customerPhone;
            
            if(!custName || custName.trim() === "") custName = "Ø²Ø¨ÙˆÙ† Ù†Ù‚Ø¯ÙŠ"; 

            if ((type === 'credit' || type === 'partial') && custName === "Ø²Ø¨ÙˆÙ† Ù†Ù‚Ø¯ÙŠ") {
                showToast("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„Ù„Ø¯ÙŠÙ†");
                return;
            }

            let remainingDebt = 0;

            if(type === 'credit') {
                remainingDebt = finalTotal;
            } else if (type === 'partial') {
                let paid = parseInt(document.getElementById('paidAmountInput').value);
                if(isNaN(paid) || paid < 0) return showToast('Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­');
                if(paid > finalTotal) return showToast('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨!');
                remainingDebt = finalTotal - paid;
            }

            if(type !== 'cash') {
                const existing = debts.find(d => d.name === custName);
                if(existing) { 
                    existing.amount += remainingDebt; 
                    existing.history.push({date: new Date().toLocaleString(), amount: remainingDebt, type: 'new'}); 
                } else { 
                    debts.push({
                        id: Date.now(), 
                        name: custName, 
                        phone: custPhone, 
                        amount: remainingDebt, 
                        history: [{date: new Date().toLocaleString(), amount: remainingDebt, type: 'new'}]
                    }); 
                }
                if(remainingDebt > 0) showToast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù‚ÙŠ ${remainingDebt} Ø¹Ù„Ù‰ ${custName}`);
            }

            // Update product stock
            cart.forEach(c => { 
                const p = products.find(prod => prod.id === c.id); 
                if(p) p.stock -= c.qty; 
            });
            
            let totalProfit = 0;
            cart.forEach(c => {
                let cost = c.originalCost || 0;
                totalProfit += (c.price - cost) * c.qty;
            });
            totalProfit -= invoiceDiscount;

            const newArchiveItem = {
                id: document.getElementById('invoiceNum').innerText, 
                date: new Date().toLocaleString(), 
                items: [...cart], 
                total: finalTotal, 
                profit: totalProfit || 0, 
                type: type, 
                customer: custName,
                phone: custPhone
            };
            
            archive.unshift(newArchiveItem);
            if(archive.length > 100) archive.pop();

            await saveAll();
            closeModal();

            // Check low stock after sale
            await checkLowStock();

            setTimeout(() => {
                if(pendingAction === 'print') window.print();
                else if(pendingAction === 'image') saveAsImage();
                else if(pendingAction === 'whatsapp') sendWhatsapp(custName, type);
                setTimeout(clearCart, 1000);
            }, 500);
        }

        async function clearCart() {
            cart = []; 
            invoiceDiscount = 0; 
            customerName = "";
            customerPhone = "";
            document.getElementById('invoiceNum').innerText = Math.floor(Math.random()*9000)+1000;
            updateCustomerDisplay();
            updateCartUI(); 
            // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            allProductCards.forEach(updateProductCard);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª
            // showToast('ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº'); 
            
            closeModal();
            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†
        }

        function saveAsImage() {
            const el = document.getElementById('invoiceToSave');
            const btns = document.querySelectorAll('#cartItems button, .btn-edit-cart'); 
            btns.forEach(b => b.style.display='none');
            document.querySelectorAll('.editable-price').forEach(e => e.style.textDecoration='none');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø¹Ù†Ø§ØµØ± ØªØ­Ø±ÙŠØ±ÙŠØ©
            document.querySelectorAll('.customer-info-item').forEach(item => {
                item.style.cursor = 'default';
            });
            
            html2canvas(el, {scale:2}).then(canvas => {
                btns.forEach(b => b.style.display='inline-block'); 
                document.querySelectorAll('.editable-price').forEach(e => e.style.textDecoration='underline dashed');
                document.querySelectorAll('.customer-info-item').forEach(item => {
                    item.style.cursor = 'pointer';
                });

                const link = document.createElement('a'); 
                link.download = `ÙØ§ØªÙˆØ±Ø©_${Date.now()}.jpg`; 
                link.href = canvas.toDataURL(); 
                link.click();
            });
        }

        function sendWhatsapp(name, type) {
            let txt = `*ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø£Ø¨Ùˆ Ø­Ø³Ù†*\nØ±Ù‚Ù…: ${document.getElementById('invoiceNum').innerText}\nØ§Ù„Ø²Ø¨ÙˆÙ†: ${name}\n`;
            if (customerPhone) txt += `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${customerPhone}\n`;
            cart.forEach(i => txt += `${i.name} (${i.qty}) : ${i.price.toLocaleString()}\n`);
            let totalTxt = document.getElementById('invoiceCalculations').innerText.replace(/\n/g, ' ');
            txt += `\n*${totalTxt}*\n${settings.footer}`;
            
            let url = "https://wa.me/?text=" + encodeURIComponent(txt);
            window.open(url, '_blank');
        }

        function renderDebts() {
            const list = document.getElementById('debtList');
            const q = document.getElementById('debtSearch').value.toLowerCase();
            list.innerHTML = '';
            const filtered = debts.filter(d => d.amount > 0 && d.name.toLowerCase().includes(q));
            if(filtered.length === 0) { 
                list.innerHTML = '<p style="text-align:center">Ù…Ø§ÙƒÙˆ Ø¯ÙŠÙˆÙ†</p>'; 
                return; 
            }
            filtered.forEach(d => {
                const div = document.createElement('div'); 
                div.className = 'debt-card';
                div.onclick = function(e) { 
                    if(!e.target.closest('.btn')) openDebtHistory(d.id); 
                };
                
                div.innerHTML = `
                    <div class="debt-info">
                        <h4>${d.name}</h4>
                        <span style="font-size:0.8rem; color:#aaa">Ø¢Ø®Ø±: ${d.history[d.history.length-1].date.split(',')[0]}</span>
                    </div>
                    <div style="text-align:left">
                        <div class="debt-amount">${d.amount.toLocaleString()}</div>
                        <button class="btn btn-print" style="padding:5px 10px; font-size:0.8rem; margin-top:5px;">ØªØ³Ø¯ÙŠØ¯</button>
                    </div>
                `;
                const payBtn = div.querySelector('.btn-print');
                payBtn.onclick = function(e) { 
                    e.stopPropagation(); 
                    payDebt(d.id); 
                };
                list.appendChild(div);
            });
        }

        function openArchiveDetails(id) {
            const item = archive.find(a => a.id == id);
            if(!item) return;
            
            let rows = '';
            item.items.forEach(i => {
                rows += `<div class="detail-row"><span>${i.name} (x${i.qty})</span><span>${(i.price*i.qty).toLocaleString()}</span></div>`;
            });
            
            showModal(`ÙØ§ØªÙˆØ±Ø© #${item.id}`, `
                <div class="date-info">${item.date}</div>
                <div class="customer-info">${item.customer} ${item.phone ? '('+item.phone+')' : ''}</div>
                <div class="detail-container">
                    ${rows}
                    <div class="detail-total">
                        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${item.total.toLocaleString()}
                    </div>
                </div>
            `);
        }

        function openDebtHistory(id) {
            const debt = debts.find(d => d.id == id);
            if(!debt) return;
            let historyHtml = '';
            const recentHistory = debt.history.slice().reverse().slice(0, 10);
            recentHistory.forEach(h => {
                const isPay = h.type === 'pay';
                historyHtml += `
                    <div class="history-item">
                        <div style="display:flex; justify-content:space-between;">
                            <span>${isPay ? 'ØªØ³Ø¯ÙŠØ¯ ğŸ’µ' : 'Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯ ğŸ“’'}</span>
                            <span class="hist-val ${isPay ? 'hist-type-pay' : 'hist-type-new'}">${h.amount.toLocaleString()}</span>
                        </div>
                        <div class="hist-date">${h.date}</div>
                    </div>
                `;
            });
            showModal(`ÙƒØ´Ù Ø­Ø³Ø§Ø¨: ${debt.name}`, `
                <h2 style="color:var(--red); text-align:center;">${debt.amount.toLocaleString()}</h2>
                ${debt.phone ? '<p style="text-align:center; color:#aaa">'+debt.phone+'</p>' : ''}
                <div style="max-height:200px; overflow-y:auto; margin-top:10px;">
                    ${historyHtml}
                </div>
            `);
        }

        function payDebt(id) {
            const d = debts.find(x => x.id == id);
            showModal(`ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ†: ${d.name}`, `<p>Ø¨Ø§Ù‚ÙŠ: ${d.amount.toLocaleString()}</p><input type="number" id="payAmount" class="modal-input" placeholder="Ø§Ù„ÙˆØ§ØµÙ„"><button class="btn btn-print" style="width:100%;" onclick="confirmPay(${id})">ØªØ³Ø¬ÙŠÙ„</button>`);
        }
        
        async function confirmPay(id) {
            const amount = Number(document.getElementById('payAmount').value);
            const d = debts.find(x => x.id == id);
            if(amount > 0 && amount <= d.amount) { 
                d.amount -= amount; 
                d.history.push({date: new Date().toLocaleString(), amount: amount, type: 'pay'}); 
                await saveAll(); 
                renderDebts(); 
                closeModal(); 
                showToast('ØªÙ…'); 
            } else { 
                showToast('Ù…Ø¨Ù„Øº Ø®Ø·Ø£'); 
            }
        }

        function toggleGlobalLock() { 
            if(isGlobalUnlocked) { 
                isGlobalUnlocked = false; 
                updateLockIcon(); 
                showToast('ØªÙ… Ø§Ù„Ù‚ÙÙ„'); 
            } else { 
                secureAccess(() => { 
                    isGlobalUnlocked = true; 
                    updateLockIcon(); 
                    showToast('Ù…ÙØªÙˆØ­'); 
                }); 
            } 
        }
        
        function updateLockIcon() { 
            const icon = document.getElementById('lockIcon'); 
            icon.innerText = isGlobalUnlocked ? 'ğŸ”“' : 'ğŸ”’'; 
            icon.className = isGlobalUnlocked ? 'lock-status-open' : 'lock-status-closed'; 
        }
        
        function secureAccess(callback) { 
            if(isGlobalUnlocked) { 
                callback(); 
            } else { 
                showModal('Ø±Ù…Ø² Ø³Ø±ÙŠ', `
                    <input type="password" id="pinInput" class="modal-input" placeholder="****" inputmode="numeric">
                    <button class="btn btn-image" style="width:100%;" onclick="checkPin()">Ø¯Ø®ÙˆÙ„</button>
                `); 
                window.tempCallback = callback; 
            } 
        }
        
        async function checkPin() { 
            const inputPin = document.getElementById('pinInput').value;
            if (inputPin) {
                const isCorrect = await verifyPassword(inputPin, settings.pinHash);
                if (isCorrect) { 
                    closeModal(); 
                    if(window.tempCallback) window.tempCallback(); 
                } else { 
                    showToast('Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­'); 
                }
            } else {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ');
            }
        }

        function openSettings() {
            showModal('Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', `
                <label class="input-label" style="display:block;text-align:right">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªØ±ÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±)</label>
                <input type="password" id="setPin" class="modal-input" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                
                <label class="input-label" style="display:block;text-align:right">Ø§Ù„Ù†Øµ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</label>
                <textarea id="setFooter" class="modal-input" rows="3">${settings.footer}</textarea>
                
                <label class="input-label" style="display:block;text-align:right">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="text" id="setPhone" class="modal-input" value="${settings.phone}">
                
                <button class="btn btn-print" style="width:100%; margin-top:10px" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            `);
        }
        
        async function saveSettings() {
            const newPin = document.getElementById('setPin').value;
            const newFooter = document.getElementById('setFooter').value;
            const newPhone = document.getElementById('setPhone').value;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯
            if (newPin && newPin.trim() !== "") {
                try {
                    settings.pinHash = await hashPassword(newPin);
                } catch (error) {
                    showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ');
                    return;
                }
            }
            
            settings.footer = newFooter;
            settings.phone = newPhone;
            
            await saveAll(); 
            document.getElementById('phoneDisplay').innerText = settings.phone;
            document.getElementById('invFooterText').innerText = settings.footer;
            closeModal(); 
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        }

        function openAddModal() {
            showModal('Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©', `
                <input id="nName" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                <input id="nPrice" type="number" class="modal-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
                <input id="nCost" type="number" class="modal-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„ØªÙƒÙ„ÙØ©)">
                <input id="nStock" type="number" class="modal-input" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ">
                <input id="nCat" class="modal-input" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ">
                <button class="btn btn-add" style="width:100%;" onclick="addNewProd()">Ø¥Ø¶Ø§ÙØ©</button>
            `);
        }
        
        async function addNewProd() {
            const name = document.getElementById('nName').value;
            const price = document.getElementById('nPrice').value;
            const cost = document.getElementById('nCost').value || 0;
            const cat = document.getElementById('nCat').value || "Ø¹Ø§Ù…";
            if(name && price) {
                const newProd = {
                    id: Date.now(), 
                    name, 
                    price: Number(price), 
                    cost: Number(cost),
                    stock: Number(document.getElementById('nStock').value)||0, 
                    cat, 
                    code: Math.random().toString(36).substr(2,2).toUpperCase()
                };
                
                products.push(newProd);
                await dbAdd('products', newProd);
                renderCategories(); 
                // Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ØŒ Ù†Ø¹ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                allProductCards = [];
                filterProducts(); 
                closeModal();
                
                // Check low stock after adding new product
                await checkLowStock();
            }
        }

        function openEditProduct(id, e) {
            if(e) e.stopPropagation();
            const p = products.find(x => x.id == id);
            secureAccess(() => {
                showModal('ØªØ¹Ø¯ÙŠÙ„', `
                    <input id="eName" class="modal-input" value="${p.name}">
                    <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                    <input id="ePrice" class="modal-input" value="${p.price}">
                    <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                    <input id="eCost" class="modal-input" value="${p.cost || 0}">
                    <label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
                    <input id="eStock" class="modal-input" value="${p.stock}">
                    <input id="eCat" class="modal-input" value="${p.cat||'Ø¹Ø§Ù…'}">
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-print" style="flex:1;" onclick="saveProdEdit(${id})">Ø­ÙØ¸</button>
                        <button class="btn btn-delete" style="flex:1;" onclick="delProd(${id})">Ø­Ø°Ù</button>
                    </div>
                `);
            });
        }
        
        async function saveProdEdit(id) {
            const p = products.find(x => x.id == id);
            p.name = document.getElementById('eName').value;
            p.price = Number(document.getElementById('ePrice').value);
            p.cost = Number(document.getElementById('eCost').value);
            p.stock = Number(document.getElementById('eStock').value);
            p.cat = document.getElementById('eCat').value;
            await dbPut('products', p);
            renderCategories(); 
            // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ØŒ Ù†Ø¹ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            allProductCards = [];
            filterProducts(); 
            closeModal();
            
            // Check low stock after editing
            await checkLowStock();
        }
        
        async function delProd(id) { 
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) { 
                products = products.filter(x => x.id != id); 
                await dbDelete('products', id);
                await saveAll(); 
                // Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ù†ØªØ¬ØŒ Ù†Ø¹ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                allProductCards = [];
                filterProducts(); 
                closeModal(); 
                
                // Check low stock after deletion
                await checkLowStock();
            } 
        }

        async function openStats() {
            try {
                let salesToday = 0, salesMonth = 0, profitToday = 0;
                let prodCounts = {};
                
                const currentDate = new Date();
                const todayStr = getTodayDateString();
                const currentMonth = currentDate.getMonth() + 1;
                const currentYear = currentDate.getFullYear();
                
                archive.forEach(a => {
                    try {
                        // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„ÙŠÙˆÙ…
                        if (a.date && a.date.includes(todayStr)) {
                            salesToday += a.total || 0; 
                            profitToday += (a.profit || 0);
                        }
                        
                        // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                        const archiveDate = new Date(a.date);
                        if (archiveDate.getMonth() + 1 === currentMonth && archiveDate.getFullYear() === currentYear) {
                            salesMonth += a.total || 0;
                        }
                        
                        // Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©
                        if (a.items && Array.isArray(a.items)) {
                            a.items.forEach(i => {
                                if (i && i.name) {
                                    prodCounts[i.name] = (prodCounts[i.name] || 0) + (i.qty || 0);
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error processing archive item:', e);
                    }
                });

                const totalDebt = debts.reduce((a,b) => a + (b.amount || 0), 0);
                document.getElementById('statToday').innerText = salesToday.toLocaleString();
                document.getElementById('statProfit').innerText = profitToday.toLocaleString();
                document.getElementById('statMonth').innerText = salesMonth.toLocaleString();
                document.getElementById('statDebtTotal').innerText = totalDebt.toLocaleString();
                
                const sortedProds = Object.entries(prodCounts).sort((a,b) => b[1] - a[1]).slice(0,3);
                document.getElementById('topProductsList').innerHTML = sortedProds.map(p => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #444;">
                        <span>${p[0]}</span>
                        <span style="color:var(--accent)">${p[1]} Ù‚Ø·Ø¹Ø©</span>
                    </div>`
                ).join('');
                
                // Initialize sales chart Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
                setTimeout(() => {
                    initSalesChart();
                }, 100);
            } catch (error) {
                console.error('Error in openStats:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
            }
        }
        
        async function resetStats() {
            showConfirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŸ', async () => {
                // Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙØŒ ÙÙ‚Ø· Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                location.reload();
            });
        }

        function showModal(t,b){ 
            document.getElementById('modalTitle').innerText=t; 
            document.getElementById('modalBody').innerHTML=b; 
            document.getElementById('mainModal').style.display='flex'; 
        }
        
        function closeModal(){ 
            document.getElementById('mainModal').style.display='none'; 
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        function closeModalOnOverlay(event) {
            if (event.target.id === 'mainModal') {
                closeModal();
            }
        }
        
        function openClearModal(){ 
            if(cart.length>0) showModal('ØªÙØ±ÙŠØº', `<button class="btn btn-delete" style="width:100%;" onclick="clearCart()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>`); 
        }

        // Initialize IndexedDB when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // The main initialization is in window.onload
        });
    </script>
</body>
</html>